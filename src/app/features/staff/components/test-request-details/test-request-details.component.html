<div class="details-container">
    <button mat-button color="primary" routerLink="../../requests" class="back-button">
        <mat-icon>arrow_back</mat-icon> Back to Requests
    </button>

    <div *ngIf="request$ | async as request; else loading">
        <mat-card class="details-card">
            <mat-card-header>
                <div class="card-header-content">
                    <div mat-card-avatar class="avatar">
                        <mat-icon>science</mat-icon>
                    </div>
                    <div>
                        <mat-card-title>Test Request Details</mat-card-title>
                        <mat-card-subtitle>ID: {{ request.id }}</mat-card-subtitle>
                    </div>
                    <div class="spacer"></div>
                    <div>
                        <span class="status-badge" [class.status-completed]="request.status === 'COMPLETED'"
                            [class.status-in-progress]="request.status === 'IN_PROGRESS'"
                            [class.status-cancelled]="request.status === 'CANCELLED'"
                            [class.status-pending]="request.status === 'PENDING'">
                            {{ request.status }}
                        </span>
                    </div>
                </div>
            </mat-card-header>

            <mat-divider></mat-divider>

            <mat-card-content class="pt-6">
                <div class="content-grid">
                    <!-- Patient Info -->
                    <div class="info-section patient-section">
                        <div class="section-header">
                            <div class="section-icon patient-icon">
                                <mat-icon>person</mat-icon>
                            </div>
                            <h3 class="section-title">Patient Information</h3>
                        </div>
                        <div class="info-group">
                            <div class="info-item">
                                <mat-icon class="item-icon">badge</mat-icon>
                                <span class="label">Name:</span>
                                <span class="value">{{ ((request.patient?.name || request.patientName) | titlecase) ||
                                    'N/A' }}</span>
                            </div>
                            <div class="info-item">
                                <mat-icon class="item-icon">fingerprint</mat-icon>
                                <span class="label">Patient ID:</span>
                                <span class="value">{{ request.patientId }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Test Info -->
                    <div class="info-section test-section">
                        <div class="section-header">
                            <div class="section-icon test-icon">
                                <mat-icon>biotech</mat-icon>
                            </div>
                            <h3 class="section-title">Test Information</h3>
                        </div>
                        <div class="info-group">
                            <div class="info-item">
                                <mat-icon class="item-icon">science</mat-icon>
                                <span class="label">Test Name:</span>
                                <span class="value">{{ request.test?.name || request.testId || 'N/A' }}</span>
                            </div>
                            <div class="info-item">
                                <mat-icon class="item-icon">qr_code</mat-icon>
                                <span class="label">Test Code:</span>
                                <span class="value">{{ request.test || 'N/A' }}</span>
                            </div>
                            <div class="info-item">
                                <mat-icon class="item-icon">low_priority</mat-icon>
                                <span class="label">Priority:</span>
                                <span class="value priority-badge" [class.high]="request.priority === 'HIGH'"
                                    [class.medium]="request.priority === 'MEDIUM'"
                                    [class.low]="request.priority === 'LOW'">
                                    {{ request.priority || 'N/A' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Info -->
                    <div class="info-section financial-section full-width">
                        <div class="section-header">
                            <div class="section-icon financial-icon">
                                <mat-icon>account_balance_wallet</mat-icon>
                            </div>
                            <h3 class="section-title">Financial Details</h3>
                        </div>
                        <div class="financial-grid">
                            <div class="financial-card">
                                <mat-icon class="financial-card-icon">attach_money</mat-icon>
                                <div class="financial-card-content">
                                    <span class="financial-label">Price</span>
                                    <span class="financial-value">{{ request.test?.price |
                                        currency:'NGN':'symbol-narrow' }}</span>
                                </div>
                            </div>
                            <div class="financial-card">
                                <mat-icon class="financial-card-icon">percent</mat-icon>
                                <div class="financial-card-content">
                                    <span class="financial-label">Discount</span>
                                    <span class="financial-value">{{ request.discount }}%</span>
                                    <span class="financial-note" *ngIf="request.discount_reason">({{
                                        request.discount_reason }})</span>
                                </div>
                            </div>
                            <div class="financial-card balance-card">
                                <mat-icon class="financial-card-icon">account_balance</mat-icon>
                                <div class="financial-card-content">
                                    <span class="financial-label">Outstanding Balance</span>
                                    <span class="balance-amount">{{ request.outstanding_balance |
                                        currency:'NGN':'symbol-narrow' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button mat-flat-button color="primary" class="action-btn view-result-btn"
                                *ngIf="request.result" (click)="openViewResultDialog(request)">
                                <mat-icon>visibility</mat-icon> View Result
                            </button>
                            <button mat-flat-button color="accent" class="action-btn result-btn" *ngIf="!request.result"
                                (click)="openResultDialog(request)">
                                <mat-icon>assignment_turned_in</mat-icon> Add Result
                            </button>
                            <button mat-flat-button color="primary" class="action-btn payment-btn"
                                *ngIf="(request.outstanding_balance ?? 0) > 0" (click)="openPaymentDialog(request)">
                                <mat-icon>payment</mat-icon> Add Payment
                            </button>
                        </div>
                    </div>
                </div>


                <div class="notes-section" *ngIf="request.notes">
                    <div class="section-header">
                        <div class="section-icon notes-icon">
                            <mat-icon>description</mat-icon>
                        </div>
                        <h3 class="section-title">Clinical Notes</h3>
                    </div>
                    <div class="notes-box">
                        <mat-icon class="notes-icon-inline">sticky_note_2</mat-icon>
                        <p class="notes-content">{{ request.notes }}</p>
                    </div>
                </div>

            </mat-card-content>
        </mat-card>
    </div>

    <ng-template #loading>
        <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
        </div>
    </ng-template>
</div>