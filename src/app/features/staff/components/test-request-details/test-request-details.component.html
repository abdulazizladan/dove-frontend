<div class="details-container">
    <button mat-button color="primary" routerLink="../../requests" class="back-button">
        <mat-icon>arrow_back</mat-icon> Back to Requests
    </button>

    <div *ngIf="request$ | async as request; else loading">
        <mat-card class="details-card">
            <mat-card-header>
                <div class="card-header-content">
                    <div mat-card-avatar class="avatar">
                        <mat-icon>science</mat-icon>
                    </div>
                    <div>
                        <mat-card-title>Test Request Details</mat-card-title>
                        <mat-card-subtitle>ID: {{ request.id }}</mat-card-subtitle>
                    </div>
                    <div class="spacer"></div>
                    <div>
                        <span class="status-badge" [class.status-completed]="request.status === 'COMPLETED'"
                            [class.status-in-progress]="request.status === 'IN_PROGRESS'"
                            [class.status-cancelled]="request.status === 'CANCELLED'"
                            [class.status-pending]="request.status === 'PENDING'">
                            {{ request.status }}
                        </span>
                    </div>
                </div>
            </mat-card-header>

            <mat-divider></mat-divider>

            <mat-card-content class="pt-6">
                <div class="content-grid">
                    <!-- Patient Info -->
                    <div class="info-group">
                        <h3 class="section-title">Patient Information</h3>
                        <div class="info-group">
                            <p class="info-item"><span class="label">Name:</span> {{ ((request.patient?.name ||
                                request.patientName) | titlecase) || 'N/A' }}</p>
                            <p class="info-item"><span class="label">Patient ID:</span> {{ request.patientId }}</p>
                        </div>
                    </div>

                    <!-- Test Info -->
                    <div class="info-group">
                        <h3 class="section-title">Test Information</h3>
                        <div class="info-group">
                            <p class="info-item"><span class="label">Test Name:</span> {{ request.test?.name ||
                                request.testId || 'N/A' }}</p>
                            <p class="info-item"><span class="label">Test Code:</span> {{ request.test || 'N/A' }}</p>
                            <p class="info-item"><span class="label">Priority:</span> {{ request.priority || 'N/A' }}
                            </p>
                        </div>
                    </div>

                    <!-- Financial Info -->
                    <div class="info-group">
                        <h3 class="section-title">Financials</h3>
                        <div class="info-group">
                            <p class="info-item"><span class="label">Price:</span> {{ request.test?.price |
                                currency:'NGN':'symbol-narrow' }}</p>
                            <p class="info-item"><span class="label">Discount:</span> {{ request.discount }}% <span
                                    *ngIf="request.discount_reason">({{ request.discount_reason }})</span></p>
                            <p class="info-item">
                                <span class="label">Balance Due:</span>
                                <span class="balance-amount">{{ request.outstanding_balance |
                                    currency:'NGN':'symbol-narrow' }}</span>
                            </p>

                            <button mat-flat-button color="accent" (click)="openResultDialog(request)">
                                <mat-icon>assignment_turned_in</mat-icon> Add Result
                            </button>
                            <button mat-flat-button color="primary" *ngIf="(request.outstanding_balance ?? 0) > 0"
                                (click)="openPaymentDialog(request)">
                                <mat-icon>payment</mat-icon> Add Payment
                            </button>
                        </div>
                    </div>
                </div>

                <div class="notes-section" *ngIf="request.notes">
                    <h3 class="section-title">Clinical Notes</h3>
                    <p class="notes-box">{{ request.notes }}</p>
                </div>

            </mat-card-content>
        </mat-card>
    </div>

    <ng-template #loading>
        <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
        </div>
    </ng-template>
</div>